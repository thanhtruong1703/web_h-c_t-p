<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>·ª®ng D·ª•ng Tr·∫Øc Nghi·ªám T·ª± Nh·∫≠p</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            }
        };
    </script>
    <style>
        .btn-submit {
            position: absolute; /* V·ªã tr√≠ tuy·ªát ƒë·ªëi */
            top: 20px;      /* C√°ch c·∫°nh d∆∞·ªõi 20px */
            right: 150px;       /* C√°ch c·∫°nh ph·∫£i 20px */
            padding: 6px 12px;
            font-size: 17px;
            color: white;
            background-color:#dc3545;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn-back {
            position: absolute; /* V·ªã tr√≠ tuy·ªát ƒë·ªëi */
            top: 20px;      /* C√°ch c·∫°nh d∆∞·ªõi 20px */
            right: 150px;       /* C√°ch c·∫°nh ph·∫£i 20px */
            padding: 6px 12px;
            font-size: 17px;
            color: white;
            background-color:#25c232;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .btn-start {
            position: absolute; /* V·ªã tr√≠ tuy·ªát ƒë·ªëi */
            top: 20px;      /* C√°ch c·∫°nh d∆∞·ªõi 20px */
            right: 240px;       /* C√°ch c·∫°nh ph·∫£i 20px */
            padding: 6px 12px;
            font-size: 17px;
            color: white;
            background-color:#6774ec;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        

        .back-button {
            position: absolute; /* V·ªã tr√≠ tuy·ªát ƒë·ªëi */
            top: 20px;      /* C√°ch c·∫°nh d∆∞·ªõi 20px */
            right: 150px;       /* C√°ch c·∫°nh ph·∫£i 20px */
            padding: 6px 12px;
            font-size: 17px;
            color: white;
            background-color:#6774ec;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .back-button:hover {
            background-color: #2980b9;
        }
        .question-item {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6 !important;
        }
        
        .answers-list {
            margin-left: 0;
        }
        
        .answer-item {
            transition: background-color 0.2s;
        }
        
        .answer-item:hover {
            background-color: #e9ecef;
        }
        
        .answer-content {
            display: inline;
            white-space: normal;
        }
        
        /* ƒê·∫£m b·∫£o radio v√† n·ªôi dung c√πng d√≤ng */
        .answers-list label {
            display: flex;
            align-items: flex-start;
            cursor: pointer;
            margin-bottom: 0;
        }
        
        /* CƒÉn ch·ªânh c√¥ng th·ª©c to√°n */
        .MathJax {
            display: inline !important;
        }

        .locked-answer {
            pointer-events: none;
            opacity: 0.7;
        }
        
        .correct-answer {
            background-color: #e6ffed !important;
            border-left: 4px solid #28a745 !important;
        }
        
        .incorrect-answer {
            background-color: #fff0f0 !important;
            border-left: 4px solid #dc3545 !important;
        }
        #scoreDisplay {
            font-size: 1.2rem;
            font-weight: bold;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
        }
        
        .score-pass {
            color: #28a745;
            background-color: #e6ffed;
        }
        
        .score-fail {
            color: #dc3545;
            background-color: #fff0f0;
        }
        
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="quiz-container">
            <h1 class="text-center">ƒê·ªÄ THI TR·∫ÆC NGHI·ªÜM</h1>


            <div id="fileListSection" class="mt-4">
                <button type="button" class="btn btn-info" onclick="toggleFileList()">Hi·ªÉn th·ªã File ƒê√£ L∆∞u</button>
                <ul id="fileList" class="mt-3"></ul>
            </div>

            <div id="inputSection" class="mb-4">
                <label for="fileInput" class="form-label">Ch·ªçn File:</label>
                <input type="file" id="fileInput" class="form-control" accept=".docx" style="padding-bottom: 35px;">
                <div id="fileStorageActions" class="mt-3">
                    <button type="button" class="btn btn-primary" onclick="saveFileToIndexedDB()">L∆∞u File</button>
                    <!-- <button type="button" class="btn btn-secondary" onclick="getFileFromIndexedDB()">T·∫£i File</button> -->
                    <!-- <button type="button" class="btn btn-info" onclick="checkFileInIndexedDB()">Ki·ªÉm tra File</button> -->
                </div>
            </div>


            <div id="feedback" class="mt-4 text-center"></div> <!-- Th√¥ng b√°o s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->

            <button class="back-button" id="back" onclick="goBack()">Quay l·∫°i</button>

            <script>
                function goBack() {
                    // Quay l·∫°i trang tr∆∞·ªõc ƒë√≥
                    window.history.back();
                }
            </script>
            <button type="button" class="btn btn-back" id="backBtn" onclick="backToStart()" style="display: none;">Quay l·∫°i</button>
            <button type="button" class="btn btn-start" id="startBtn" onclick="startQuiz()">L√†m b√†i</button>
            <button type="button" class="btn btn-submit" id="submitBtn" onclick="submitQuiz()" style="display: none;">N·ªôp b√†i</button>
            <!-- Th√™m div hi·ªÉn th·ªã ƒëi·ªÉm ngay sau n√∫t N·ªôp b√†i -->
            <div id="scoreDisplay" class="mt-3 text-center" style="display: none;"></div>

            <!-- Ph·∫ßn nh·∫≠p c√¢u h·ªèi th·ªß c√¥ng -->
            <div id="manualQuestionSection" class="mb-4">      
                <form id="add-question-form">
                    <h2 class="text-primary">T·∫°o C√¢u H·ªèi Th·ªß C√¥ng </h2>
                    <div class="alert alert-info">
                        <p><strong>L∆∞u √Ω:</strong> ƒê·ªÉ nh·∫≠p c√¥ng th·ª©c to√°n h·ªçc, s·ª≠ d·ª•ng c√∫ ph√°p LaTeX gi·ªØa 2 d·∫•u $ (v√≠ d·ª•: $$x^2 + y^2 = z^2$$ )</p>
                    </div>
                    <div class="form-group">
                        <label for="question">Nh·∫≠p C√¢u h·ªèi:</label>
                        <textarea class="form-control" id="question" name="question" rows="2" required oninput="toggleAddQuestionButton()"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="optionA">ƒê√°p √°n A:</label>
                            <textarea class="form-control" id="optionA" name="optionA" rows="2" required oninput="toggleAddQuestionButton()"></textarea>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="optionB">ƒê√°p √°n B:</label>
                            <textarea class="form-control" id="optionB" name="optionB" rows="2" required oninput="toggleAddQuestionButton()"></textarea>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="optionC">ƒê√°p √°n C:</label>
                            <textarea class="form-control" id="optionC" name="optionC" rows="2" required oninput="toggleAddQuestionButton()"></textarea>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="optionD">ƒê√°p √°n D:</label>
                            <textarea class="form-control" id="optionD" name="optionD" rows="2" required oninput="toggleAddQuestionButton()"></textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="correctOption">Ch·ªçn ƒë√°p √°n ƒë√∫ng:</label>
                        <select id="correctOption" name="correctOption" class="form-control" required oninput="toggleAddQuestionButton()">
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-primary" id="addQuestionButton" onclick="addQuestion()" disabled>Th√™m c√¢u h·ªèi</button>
                </form>
            </div>
            <div id="quizContent" class="mt-4">
                <!-- N·ªôi dung c√¢u h·ªèi th√™m ·ªü ƒë√¢y -->
            </div>
        </div>
    </div> 

    <script>

        // t·∫°o l∆∞u tr·ªØ
        let db;
        // H√†m m·ªü IndexedDB
        function openDB(callback) {
            if (db) {
                callback();
                return;
            }

            const request = indexedDB.open("FileStorageDB", 4);

            request.onupgradeneeded = function (event) {
                db = event.target.result;

                if (!db.objectStoreNames.contains("dsfiles")) {
                    db.createObjectStore("dsfiles", { keyPath: "id" });
                }

                if (!db.objectStoreNames.contains("files")) {
                    db.createObjectStore("files", { keyPath: "id" });
                }

                if (!db.objectStoreNames.contains("tlnfiles")) {
                    db.createObjectStore("tlnfiles", { keyPath: "id" });
                }

                if (!db.objectStoreNames.contains("rank")) {
                    const rankStore = db.createObjectStore("rank", { keyPath: "name" }); // S·ª≠ d·ª•ng t√™n l√†m key
                    rankStore.createIndex("score", "score", { unique: false });
                }
            };
            

            request.onsuccess = function (event) {
                db = event.target.result;
                //console.log("‚úÖ IndexedDB ƒë√£ m·ªü th√†nh c√¥ng!");
                callback();
            };

            request.onerror = function (event) {
                console.error("‚ùå L·ªói m·ªü IndexedDB:", event.target.error);
                showFeedback("Kh√¥ng th·ªÉ m·ªü IndexedDB!", "red");
            };
        }
        
        
        // H√†m l∆∞u file v√†o IndexedDB
        // H√†m l∆∞u file v√†o IndexedDB
        function saveFileToIndexedDB() {
            openDB(() => {
                const fileInput = document.getElementById("fileInput");
                if (!fileInput || fileInput.files.length === 0) {
                    showFeedback("‚ùå Vui l√≤ng ch·ªçn m·ªôt file!", "red");
                    return;
                }

                const file = fileInput.files[0];
                //console.log("üìÇ File ƒë∆∞·ª£c ch·ªçn:", file);

                const reader = new FileReader();
                reader.onload = function (event) {
                    const fileData = event.target.result;

                    const transaction = db.transaction(["files"], "readwrite");
                    const store = transaction.objectStore("files");

                    const uniqueId = 'TN-' + crypto.randomUUID(); // T·∫°o ID duy nh·∫•t
                    const fileRecord = { id: uniqueId, name: file.name, content: fileData };

                    const request = store.put(fileRecord);

                    request.onsuccess = function () {
                        console.log("‚úÖ File ƒë√£ l∆∞u th√†nh c√¥ng!");
                        showFeedback("L∆∞u file th√†nh c√¥ng!", "green");
                    };

                    request.onerror = function (event) {
                        console.error("‚ùå L·ªói l∆∞u file:", event.target.error);
                        showFeedback("L∆∞u file th·∫•t b·∫°i!", "red");
                    };
                };

                reader.onerror = function () {
                    console.error("‚ùå L·ªói ƒë·ªçc file!");
                    showFeedback("L·ªói khi ƒë·ªçc file!", "red");
                };

                reader.readAsDataURL(file);
            });
        }

        // Hi·ªÉn th·ªã th√¥ng b√°o tr√™n giao di·ªán
        function showFeedback(message, color) {
            const feedback = document.getElementById("feedback");
            feedback.innerText = message;
            feedback.style.color = color;
            setTimeout(() => {
                feedback.innerText = "";
            }, 1000);
        }


        //// h√†m hi·ªán danh s√°ch ƒë√£ l∆∞u
        function toggleFileList() {
            const fileList = document.getElementById("fileList");
            
            if (!fileList) {
                console.error("Ph·∫ßn t·ª≠ fileList kh√¥ng t·ªìn t·∫°i. Vui l√≤ng ki·ªÉm tra l·∫°i ID c·ªßa ph·∫ßn t·ª≠ n√†y.");
                return;
            }
            
            // ƒê·∫∑t tr·∫°ng th√°i m·∫∑c ƒë·ªãnh n·∫øu ch∆∞a ƒë∆∞·ª£c ƒë·∫∑t
            //if (!fileList.style.display) {fileList.style.display = "none";}
        
            if (fileList.style.display === "none" || fileList.style.display === "")  {
                fileList.style.display = "block";
                listAllFiles();
            } else {
                fileList.style.display = "none";
            }
        }

        function listAllFiles() {
            openDB(() => {  // ƒê·∫£m b·∫£o DB ƒë√£ m·ªü tr∆∞·ªõc khi truy v·∫•n
                const transaction = db.transaction(["files"], "readonly");
                const store = transaction.objectStore("files");
                const request = store.getAll();
        
                request.onsuccess = function (event) {
                    const files = event.target.result;
                    const fileList = document.getElementById("fileList");
                    fileList.innerHTML = ""; // X√≥a danh s√°ch c≈© tr∆∞·ªõc khi c·∫≠p nh·∫≠t
        
                    if (files.length > 0) {
                        // T·∫°o b·∫£ng ƒë·ªÉ hi·ªÉn th·ªã danh s√°ch file
                        const table = document.createElement("table");
                        table.style.width = "100%";
                        table.style.borderCollapse = "collapse";
        
                        // T·∫°o ti√™u ƒë·ªÅ b·∫£ng
                        const thead = document.createElement("thead");
                        thead.innerHTML = `
                            <tr style="background: #f2f2f2;">
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">üìÑ T√™n File</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">üì• T·∫£i Xu·ªëng</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">‚ùå X√≥a</th>
                            </tr>
                        `;
                        table.appendChild(thead);
        
                        // T·∫°o ph·∫ßn th√¢n b·∫£ng
                        const tbody = document.createElement("tbody");
        
                        files.forEach(file => {
                            const row = document.createElement("tr");
        
                            // √î t√™n file
                            const fileNameCell = document.createElement("td");
                            fileNameCell.textContent = file.name;
                            fileNameCell.style.border = "1px solid #ddd";
                            fileNameCell.style.padding = "8px";
                            fileNameCell.style.cursor = "pointer";
                            fileNameCell.style.color = "blue";
                            fileNameCell.style.textDecoration = "underline";
                            
                            // Khi nh·∫•n v√†o t√™n file, s·∫Ω m·ªü b√†i l√†m
                            fileNameCell.onclick = function () {
                                loadFileForQuiz(file.id);
                            };
                            
        
                            // √î n√∫t t·∫£i xu·ªëng
                            const downloadCell = document.createElement("td");
                            downloadCell.style.textAlign = "center";
                            downloadCell.style.border = "1px solid #ddd";
                            downloadCell.style.padding = "8px";
        
                            const downloadBtn = document.createElement("button");
                            downloadBtn.textContent = "üì• T·∫£i xu·ªëng";
                            downloadBtn.style.backgroundColor = "#28a745"; // M√†u xanh l√°
                            downloadBtn.style.color = "white";
                            downloadBtn.style.border = "none";
                            downloadBtn.style.padding = "5px 10px";
                            downloadBtn.style.borderRadius = "5px";
                            downloadBtn.style.cursor = "pointer";
                            downloadBtn.onclick = function() {
                                downloadFile(file);
                            };
                            downloadCell.appendChild(downloadBtn);
        
                            // √î n√∫t x√≥a
                            const deleteCell = document.createElement("td");
                            deleteCell.style.textAlign = "center";
                            deleteCell.style.border = "1px solid #ddd";
                            deleteCell.style.padding = "8px";
        
                            const deleteBtn = document.createElement("button");
                            deleteBtn.textContent = "‚ùå X√≥a";
                            deleteBtn.style.backgroundColor = "#dc3545"; // M√†u ƒë·ªè
                            deleteBtn.style.color = "white";
                            deleteBtn.style.border = "none";
                            deleteBtn.style.padding = "5px 10px";
                            deleteBtn.style.borderRadius = "5px";
                            deleteBtn.style.cursor = "pointer";
                            deleteBtn.onclick = function() {
                                deleteFile(file.id);
                            };
                            deleteCell.appendChild(deleteBtn);
        
                            // Th√™m c√°c √¥ v√†o h√†ng
                            row.appendChild(fileNameCell);
                            row.appendChild(downloadCell);
                            row.appendChild(deleteCell);
        
                            // Th√™m h√†ng v√†o tbody
                            tbody.appendChild(row);
                        });
        
                        table.appendChild(tbody);
                        fileList.appendChild(table);
                    } else {
                        fileList.innerHTML = "<p style='text-align:center;'>Kh√¥ng c√≥ file n√†o trong kho l∆∞u tr·ªØ</p>";
                    }
                };
        
                request.onerror = function () {
                    alert("L·ªói khi truy c·∫≠p danh s√°ch file!");
                };
            });
            // h√†m download file
            function downloadFile(file) {
                const link = document.createElement("a");
                link.href = file.content; // N·ªôi dung file ·ªü d·∫°ng base64
                link.download = file.name;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            /// h√†m x√≥a file
            function deleteFile(fileId) {
                openDB(() => {
                    const transaction = db.transaction(["files"], "readwrite");
                    const store = transaction.objectStore("files");
                    const request = store.delete(fileId);
            
                    request.onsuccess = function () {
                        //alert("File ƒë√£ ƒë∆∞·ª£c x√≥a!");
                        listAllFiles(); // C·∫≠p nh·∫≠t l·∫°i danh s√°ch file sau khi x√≥a
                    };
            
                    request.onerror = function () {
                        alert("L·ªói khi x√≥a file!");
                    };
                });
            }
        }

        /// h√†m ƒë·∫©y l√™n l√†m b√†i l·∫°i 
        function loadFileForQuiz(fileId) {
            openDB(() => {
                const transaction = db.transaction(["files"], "readonly");
                const store = transaction.objectStore("files");
                const request = store.get(fileId);
        
                request.onsuccess = function (event) {
                    const file = event.target.result;
                    if (file) {
                        mammoth.extractRawText({ arrayBuffer: base64ToArrayBuffer(file.content.split(",")[1]) })
                            .then(function(output) {
                                parseQuestions(output.value);
                                startQuiz(); // Chuy·ªÉn sang giao di·ªán l√†m b√†i
                            })
                            .catch(function(err) {
                                alert("Kh√¥ng th·ªÉ ƒë·ªçc file tr·∫Øc nghi·ªám.");
                                console.error(err);
                            });
                    } else {
                        alert("Kh√¥ng t√¨m th·∫•y file!");
                    }
                };
        
                request.onerror = function () {
                    alert("L·ªói khi truy xu·∫•t file!");
                };
            });
        }
        
        // Chuy·ªÉn Base64 v·ªÅ ArrayBuffer ƒë·ªÉ ƒë·ªçc file Word
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }
        
        
        // H√†m t·∫£i file v√† chuy·ªÉn sang giao di·ªán l√†m b√†i
        function loadFile(file) {
            let reader = new FileReader();
            reader.onload = function (event) {
                let fileContent = event.target.result;
                document.getElementById("examContainer").innerHTML = fileContent; // Hi·ªÉn th·ªã ƒë·ªÅ b√†i
            };
            reader.readAsText(new Blob([file.content])); // ƒê·ªçc n·ªôi dung file ƒë√£ l∆∞u
        }
        
        
/////  l·∫•y t√™n ng∆∞·ªùi d√πng
//let userlocal = JSON.parse(localStorage.getItem("userlogin")) || [];
        

        //// h√†m t·∫°o b·∫£ng x·∫øp h·∫°ng
         // t·∫°o b·∫£ng rank
         // l∆∞u t·∫°o b·∫£ng rank
         function saveRank(name, newScore) {
            openDB(() => {
                const transaction = db.transaction(["rank"], "readwrite");
                const store = transaction.objectStore("rank");
        
                const request = store.get(name);
        
                request.onsuccess = function () {
                    const existingEntry = request.result;
        
                    if (existingEntry) {
                        // C·ªông d·ªìn ƒëi·ªÉm s·ªë m·ªõi v√†o ƒëi·ªÉm s·ªë c≈©
                        existingEntry.score += parseFloat(newScore);
        
                        const updateRequest = store.put(existingEntry);
                        updateRequest.onsuccess = function () {
                            console.log(`Score updated successfully! New total score: ${existingEntry.score}`);
                        };
                        updateRequest.onerror = function () {
                            console.error("Error updating score");
                        };
                    } else {
                        // N·∫øu ch∆∞a c√≥ d·ªØ li·ªáu, th√™m m·ªõi
                        const newEntry = { name: name, score: parseFloat(newScore) };
                        const addRequest = store.add(newEntry);
        
                        addRequest.onsuccess = function () {
                            console.log("New rank data added successfully!");
                        };
                        addRequest.onerror = function () {
                            console.error("Error adding new rank data");
                        };
                    }
                };
        
                request.onerror = function () {
                    console.error("Error checking existing entry");
                };
            });
        }
        //////////////////////  

        let questions = [];
        // S·ª± ki·ªán ƒë·ªçc file Word
        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) {
                document.getElementById('quizContent').innerHTML = '<p>Xin h√£y ch√®n file ho·∫∑c th√™m c√¢u h·ªèi th·ªß c√¥ng</p>';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const arrayBuffer = e.target.result;
                mammoth.extractRawText({ arrayBuffer: arrayBuffer })
                    .then(function(result) {
                        const text = result.value;
                        parseQuestions(text);
                    })
                    .catch(function(err) {
                        console.log(err);
                        alert('Kh√¥ng th·ªÉ ƒë·ªçc file Word');
                    });
            };
            reader.readAsArrayBuffer(file);
        });

        // H√†m ph√¢n t√≠ch c√¢u h·ªèi v√† ƒë√°p √°n t·ª´ file Word
        function parseQuestions(text) {
            const lines = text.split('\n');
            questions = [];
            let currentQuestion = null;
        
            lines.forEach(line => {
                line = line.trim();
                
                // X·ª≠ l√Ω d√≤ng tr·ªëng
                if (line === '') return;
                
                // X·ª≠ l√Ω c√¥ng th·ª©c to√°n h·ªçc - gi·ªØ nguy√™n ƒë·ªãnh d·∫°ng
                line = line.replace(/\\\(/g, '$').replace(/\\\)/g, '$');
                
                if (line.startsWith('C√¢u h·ªèi:')) {
                    if (currentQuestion) questions.push(currentQuestion);
                    currentQuestion = {
                        question: line.replace('C√¢u h·ªèi:', '').trim(),
                        options: [],
                        correctAnswer: null
                    };
                } else if (line.match(/^[A-D]:/)) {
                    const optionText = line.substring(2).trim();
                    // Lo·∫°i b·ªè k√Ω t·ª± "- ‚óã" n·∫øu c√≥
                    const cleanText = optionText.replace(/^- ‚óã\s*/, '');
                    
                    if (currentQuestion) {
                        currentQuestion.options.push({
                            text: cleanText,
                            correct: false
                        });
                    }
                } else if (line.startsWith('ƒê√°p √°n ƒë√∫ng:')) {
                    const correctAnswer = line.replace('ƒê√°p √°n ƒë√∫ng:', '').trim();
                    if (currentQuestion) {
                        const correctIndex = ['A', 'B', 'C', 'D'].indexOf(correctAnswer);
                        if (correctIndex >= 0) {
                            currentQuestion.options[correctIndex].correct = true;
                            currentQuestion.correctAnswer = correctAnswer;
                        }
                    }
                }
            });
        
            if (currentQuestion) questions.push(currentQuestion);
            
            shuffleQuestions();
            displayQuestions();
        }

        // H√†m x√°o tr·ªôn (random) c√¢u h·ªèi v√† ƒë√°p √°n
        function shuffleQuestions() {
            // X√°o tr·ªôn c√¢u h·ªèi
            questions.sort(() => Math.random() - 0.5);

            // X√°o tr·ªôn ƒë√°p √°n c·ªßa t·ª´ng c√¢u h·ªèi
            questions.forEach(q => {
                q.options.sort(() => Math.random() - 0.5);
                // ƒêi·ªÅu ch·ªânh l·∫°i ch·ªâ s·ªë ƒë√°p √°n ƒë√∫ng
                const correctOption = q.options.find(option => option.correct);
                if (correctOption) {
                    const correctIndex = q.options.indexOf(correctOption);
                    q.correctAnswer = ['A', 'B', 'C', 'D'][correctIndex];
                }
            });
        }

        // Hi·ªÉn th·ªã c√¢u h·ªèi l√™n giao di·ªán
        function displayQuestions() {
            const quizForm = document.getElementById('quizContent');
            quizForm.innerHTML = '';
        
            questions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'form-group question-item mb-4 p-3 border rounded bg-light';
                
                // Hi·ªÉn th·ªã c√¢u h·ªèi
                questionDiv.innerHTML = `<div class="question-text mb-3"><strong>C√¢u ${index + 1}:</strong> ${q.question}</div>`;
        
                // T·∫°o danh s√°ch ƒë√°p √°n
                const answersUl = document.createElement('ul');
                answersUl.className = 'answers-list list-unstyled';
                
                q.options.forEach((option, i) => {
                    const optionLetter = String.fromCharCode(65 + i);
                    const li = document.createElement('li');
                    li.className = 'answer-item mb-2 p-2 rounded';
                    
                    // Hi·ªÉn th·ªã ƒë√°p √°n tr√™n c√πng m·ªôt d√≤ng
                    li.innerHTML = `
                        <label class="d-flex align-items-center m-0">
                            <input type="radio" name="answer${index}" value="${i}" class="mr-2">
                            <span class="answer-content">${optionLetter}. ${option.text}</span>
                        </label>
                    `;
                    
                    answersUl.appendChild(li);
                });
        
                questionDiv.appendChild(answersUl);
                quizForm.appendChild(questionDiv);
            });
        
            // Render MathJax
            if (window.MathJax) {
                MathJax.typesetPromise();
            }
        }

        // H√†m b·∫Øt ƒë·∫ßu l√†m b√†i
        function startQuiz() {
            if (questions.length === 0) {
                alert("Xin h√£y th√™m file ho·∫∑c th√™m c√¢u h·ªèi.");
                return;
            }
           
            document.getElementById('inputSection').style.display = 'none';
            document.getElementById('fileListSection').style.display = 'none';
            document.getElementById('manualQuestionSection').style.display = 'none';
            document.getElementById('submitBtn').style.display = 'inline-block';
            document.getElementById('startBtn').style.display = 'none';
        }

        // H√†m n·ªôp b√†i
        function submitQuiz() {
            if (questions.length === 0) {
                showFeedback("Xin h√£y th√™m file ho·∫∑c th√™m c√¢u h·ªèi.", "red");
                return;
            }
        
            let correctAnswers = 0;
        
            // Kh√≥a t·∫•t c·∫£ c√°c input radio
            const allRadioInputs = document.querySelectorAll('input[type="radio"]');
            allRadioInputs.forEach(input => {
                input.disabled = true;
                input.parentElement.parentElement.classList.add('locked-answer');
            });
        
            questions.forEach((q, index) => {
                const selected = document.querySelector(`input[name="answer${index}"]:checked`);
                const isCorrect = selected ? q.options[selected.value].correct : false;
        
                // ƒê√°nh d·∫•u ƒë√°p √°n ƒë√∫ng/sai
                const answers = document.querySelectorAll(`input[name="answer${index}"]`);
                answers.forEach((answer) => {
                    const parentLi = answer.closest('li');
                    
                    if (q.options[answer.value].correct) {
                        // ƒê√°p √°n ƒë√∫ng
                        parentLi.classList.add('correct-answer');
                        parentLi.style.color = 'green';
                        parentLi.style.fontWeight = 'bold';
                    } else if (selected && answer.value === selected.value) {
                        // ƒê√°p √°n sai ƒë√£ ch·ªçn
                        parentLi.classList.add('incorrect-answer');
                        parentLi.style.color = 'red';
                    }
                });
        
                if (isCorrect) correctAnswers++;
            });
        
            const maxScore = 10;
            const score = (correctAnswers / questions.length) * maxScore;
            const finalScore = Math.min(Math.max(score, 0), 10);
            const scorePercentage = (correctAnswers / questions.length * 100).toFixed(1);
        
            // Hi·ªÉn th·ªã ƒëi·ªÉm
            const scoreDisplay = document.getElementById('scoreDisplay');
            scoreDisplay.style.display = 'block';
            
            // Thi·∫øt l·∫≠p m√†u s·∫Øc d·ª±a tr√™n ƒëi·ªÉm s·ªë
            if (finalScore >= 5) {
                scoreDisplay.className = 'mt-3 text-center score-pass';
            } else {
                scoreDisplay.className = 'mt-3 text-center score-fail';
            }
            
            scoreDisplay.innerHTML = `
                <div>B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng <strong>${correctAnswers}/${questions.length}</strong> c√¢u h·ªèi</div>
                <div>ƒêi·ªÉm s·ªë: <strong>${finalScore.toFixed(1)}/${maxScore}</strong> (${scorePercentage}%)</div>
            `;
        
            document.getElementById('submitBtn').style.display = 'none';
            document.getElementById('backBtn').style.display = 'inline-block';
            document.getElementById('fileListSection').style.display = 'none';
        
            //saveRank(userlocal.name, finalScore.toFixed(1));
        }

        // Quay l·∫°i ph·∫ßn nh·∫≠p c√¢u h·ªèi
        function backToStart() {
            questions = [];
            document.getElementById('quizContent').innerHTML = '';
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('fileListSection').style.display = 'block';
            document.getElementById('inputSection').style.display = 'block';
            document.getElementById('manualQuestionSection').style.display = 'block';
            document.getElementById('submitBtn').style.display = 'none';
            document.getElementById('backBtn').style.display = 'none';
            document.getElementById('scoreDisplay').style.display = 'none'; // ·∫®n ph·∫ßn hi·ªÉn th·ªã ƒëi·ªÉm
            document.getElementById('add-question-form').reset();
            
            // B·ªè kh√≥a t·∫•t c·∫£ c√°c input radio (n·∫øu c√≥)
            const allRadioInputs = document.querySelectorAll('input[type="radio"]');
            allRadioInputs.forEach(input => {
                input.disabled = false;
                if (input.parentElement && input.parentElement.parentElement) {
                    input.parentElement.parentElement.classList.remove('locked-answer');
                }
            });
        }

        // H√†m th√™m c√¢u h·ªèi th·ªß c√¥ng
        function addQuestion() {
            const question = document.getElementById('question').value;
            const optionA = document.getElementById('optionA').value;
            const optionB = document.getElementById('optionB').value;
            const optionC = document.getElementById('optionC').value;
            const optionD = document.getElementById('optionD').value;
            const correctOption = document.getElementById('correctOption').value;
        
            if (!question || !optionA || !optionB || !optionC || !optionD || !correctOption) {
                alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin c√¢u h·ªèi v√† ƒë√°p √°n!");
                return;
            }
        
            const options = [
                { text: optionA, correct: correctOption === 'A' },
                { text: optionB, correct: correctOption === 'B' },
                { text: optionC, correct: correctOption === 'C' },
                { text: optionD, correct: correctOption === 'D' }
            ];
        
            questions.push({ 
                question: question, 
                options: options,
                correctAnswer: correctOption
            });
        
            shuffleQuestions();
            displayQuestions();
            document.getElementById('addQuestionButton').disabled = true;
            document.getElementById('add-question-form').reset();
            
            // Render l·∫°i MathJax sau khi th√™m c√¢u h·ªèi m·ªõi
            if (window.MathJax) {
                MathJax.typesetPromise();
            }
        }

// K√≠ch ho·∫°t ho·∫∑c v√¥ hi·ªáu h√≥a n√∫t "Th√™m c√¢u h·ªèi" t√πy v√†o vi·ªác nh·∫≠p d·ªØ li·ªáu
function toggleAddQuestionButton() {
    const question = document.getElementById('question').value;
    const optionA = document.getElementById('optionA').value;
    const optionB = document.getElementById('optionB').value;
    const optionC = document.getElementById('optionC').value;
    const optionD = document.getElementById('optionD').value;
    const correctOption = document.getElementById('correctOption').value;

    // N√∫t "Th√™m c√¢u h·ªèi" ch·ªâ ho·∫°t ƒë·ªông khi t·∫•t c·∫£ c√°c tr∆∞·ªùng ƒë·ªÅu c√≥ gi√° tr·ªã
    const isValid = question && optionA && optionB && optionC && optionD && correctOption;

    // K√≠ch ho·∫°t n√∫t n·∫øu t·∫•t c·∫£ th√¥ng tin ƒë∆∞·ª£c ƒëi·ªÅn ƒë·∫ßy ƒë·ªß
    if (isValid) {
        document.getElementById('addQuestionButton').disabled = false;
    }
}

// S·ª± ki·ªán m·ªói khi ng∆∞·ªùi d√πng nh·∫≠p li·ªáu v√†o c√°c tr∆∞·ªùng
document.getElementById('question').addEventListener('input', toggleAddQuestionButton);
document.getElementById('optionA').addEventListener('input', toggleAddQuestionButton);
document.getElementById('optionB').addEventListener('input', toggleAddQuestionButton);
document.getElementById('optionC').addEventListener('input', toggleAddQuestionButton);
document.getElementById('optionD').addEventListener('input', toggleAddQuestionButton);
document.getElementById('correctOption').addEventListener('input', toggleAddQuestionButton);
    </script>
</body>
</html>
